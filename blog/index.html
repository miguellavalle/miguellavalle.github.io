<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Code bits sprinkled with other stuff">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>code bits and other stuff by Miguel Lavalle</title>
<link href="../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../rss.xml">
<link rel="canonical" href="https://www.miguellavalle.com/blog/">
<link rel="icon" href="../favicon-16x16.png" sizes="16x16">
<link rel="icon" href="../favicon-32x32.png" sizes="32x32">
<!--[if lt IE 9]><script src="../assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-light
bg-info
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="../">

            <span id="blog-title">code bits and other stuff by Miguel Lavalle</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../index.html" class="nav-link">Home</a>
                </li>
<li class="nav-item">
<a href="../archive.html" class="nav-link">Blog</a>
                </li>
<li class="nav-item">
<a href="../categories/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="../rss.xml" class="nav-link">RSS feed</a>

                
            </li>
</ul>
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="on-being-pythonic/" class="u-url">On being pythonic</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Miguel Lavalle
            </span></p>
            <p class="dateline">
            <a href="on-being-pythonic/" rel="bookmark">
            <time class="published dt-published" datetime="2022-01-11T17:17:30-06:00" itemprop="datePublished" title="2022-01-11">2022-01-11</time></a>
            </p>
                <p class="commentline">
        
    <a href="on-being-pythonic/#disqus_thread" data-disqus-identifier="cache/posts/on-being-pythonic.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I recently was given a Python coding challenge during a job interview. I was criticized for not writing "pythonic" enough code. The good news is that I did great with the other interviewers in the panel, so I still got the job \o/. Afterwards, though, I decided to use the criticism as a learning opportunity, revisit the challenge and write this blog post with the resulting code, while making my best effort to be "pythonic". To that end, here's a basic definition: pythonic code uses the powerful idioms of Python that distinguishes it from other languages to produce elegant and concise programs. To guide me on the road to being "pythonic", I am using the following references:</p>
<ul>
<li>
<a href="https://www.youtube.com/watch?v=OSGv2VnC0go">Transforming Code into Beautiful, Idiomatic Python</a> (<a href="https://speakerdeck.com/pyconslides/transforming-code-into-beautiful-idiomatic-python-by-raymond-hettinger-1">slides</a>) by <a href="https://github.com/rhettinger">Raymond Hettinger</a>, who is a Python core developer.</li>
<li>Since in this exercise we are going to use generators and coroutines, my other reference is <a href="https://lerner.co.il/2020/05/08/making-sense-of-generators-coroutines-and-yield-from-in-python/">Making sense of generators, coroutines, and “yield from” in Python</a> by <a href="https://lerner.co.il/">Reuven Lerner</a>, who teaches Python all over the world.</li>
</ul>
<p>In the code that follows I will cover the following topics</p>
<ul>
<li>One of the aspects that strongly distinguishes Python from other programming languages is its approach to iterations. As Raymond Hettinger argues in his presentation, Python's <code>for</code> statement should have been called <code>for each</code> to better reflect its semantics. I will talk about iterables, iterators, the iterator protocol, generators and co-routines.</li>
<li>Python's regular expresions module.</li>
<li>Improving clarity with named tuples.</li>
<li>Factoring out administrative logic with decorators.</li>
</ul>
<p>The coding problem was stated as follows:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [46]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Model a computing device that can load third party programs.</span>

<span class="c1"># PROGRAMS consist of ACTIONS that share an execution ENVIRONMENT,</span>
<span class="c1"># particularly computer STATE. ACTIONS belong to a limited set supported</span>
<span class="c1"># by this device. ACTIONS can communicate with each other through</span>
<span class="c1"># REGISTERS.</span>

<span class="c1"># PROGRAM execution results in computer STATE change. The STATE change</span>
<span class="c1"># can then be inspected.</span>

<span class="c1"># Device should allow to LOAD multiple PROGRAMS and execute them</span>
<span class="c1"># SEQUENTIALLY.</span>

<span class="c1"># Typical API of the computing device would include:</span>
<span class="c1"># - load(_program)</span>
<span class="c1"># - execute</span>
<span class="c1"># - (get_)state</span>

<span class="c1"># Implement the device, define two programs (see below), load them</span>
<span class="c1"># and execute, then show results.</span>

<span class="c1"># program1: receive int through INPUT; add +10 to the INPUT; store result.</span>
<span class="c1"># program2: load result of previous program execution; depending on if</span>
<span class="c1">#           it's &gt; 50, set a register in machine state to 100; otherwise to 0.</span>

<span class="c1"># usage example</span>
<span class="c1"># c = Computer(...)</span>
<span class="c1"># p1 = Program(...)</span>
<span class="c1"># p2 = Program(...)</span>
<span class="c1"># c.state()  # -&gt; {...}</span>
<span class="c1"># c.load(p1, input=...)</span>
<span class="c1"># c.load(p2, input=...)</span>
<span class="c1"># c.execute()</span>
<span class="c1"># c.state()  # -&gt; {...0 or 100...}</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Recognizing-instructions-with-Python-regular-expressions">Recognizing instructions with Python regular expressions<a class="anchor-link" href="on-being-pythonic/#Recognizing-instructions-with-Python-regular-expressions">¶</a>
</h3>
<p>To make parsing programs easy, the computing device (henceforth the computer) will have one operand instructions and an accumulator register. The <code>add</code> instruction, for example, adds its operand to the accumulator register. This means that we are also going to need <code>lda</code>  and <code>sto</code> instructions, that load a value to the accumulator and store the value of the accumulator in another register, respectively.  Those registers are part of the computer's state and are described further below. To be able to write <code>program1</code> and <code>program2</code> in the coding challenge, the following is the minimum action set necessary:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [47]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ACTION_SET</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">'lda'</span><span class="p">,</span> <span class="s1">'sto'</span><span class="p">,</span> <span class="s1">'bgt'</span><span class="p">,</span> <span class="s1">'cmp'</span><span class="p">,</span> <span class="s1">'add'</span><span class="p">])</span>
<span class="n">ACTIONS_NO_LITERAL</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">'sto'</span><span class="p">,</span> <span class="s1">'bgt'</span><span class="p">])</span>
<span class="n">BRANCHES</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">'bgt'</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Some instructions, like <code>lda</code> or <code>add</code> can take two types of operands, registers and literals:</p>
<ul>
<li>
<code>lda r0</code> loads the content of register <code>r0</code> to the acumulator.</li>
<li>
<code>lda #10</code> loads the value <code>10</code> to the acumulator.</li>
</ul>
<p>In the case of the <code>sto</code> instruction, though, it doesn't make sense to have literal operands. This instruction always stores the value in the acumulator in one of the registers. The set <code>ACTIONS_NO_LITERAL</code> will help in processing this type of instructions.</p>
<p>Similarly, branches only accept destination operands, which is an integer <code>i</code> from <code>0</code> to <code>n - 1</code>, where <code>n</code> is the total number of instructions in the program. Branches, like <code>bgt</code>, direct the computer to continue fetching instructions from the location specified by the destination operand.  In other words, the computer is expected to fetch next the <code>ith</code> instruction from the beginning of the program. The set <code>BRANCHES</code> will help in processing this type of instructions.</p>
<p>To parse a programs, we are going to use Python's <code>re</code> (regular expressions) module:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [48]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>

<span class="n">RE_LINE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">'^(?P&lt;action&gt;[a-z]</span><span class="si">{3}</span><span class="s1">)\s+(?P&lt;arg&gt;r[io0-9]$|\#-?[0-9]+$|[0-9]+$)'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This regular expression parses one instruction at a time. It can be divided in three parts:</p>
<ol>
<li>The named capture group <code>^(?P&lt;action&gt;[a-z]{3})</code> recognizes sequences of 3 alphabetic characters that correspond to members of <code>ACTION_SET</code>. Note that it is anchored to the beginning of the string with <code>^</code>.</li>
<li>One or more whitespaces <code>\s+</code> that separate the <code>action</code> from the <code>arg</code>.</li>
<li>The named capture group <code>(?P&lt;arg&gt;r[io0-9]$|\#-?[0-9]+$|[0-9]+$)</code>. This group can be one of three alternatives, separated by <code>|</code> in the regular expression (note that each alternative is anchored to the end of the string with <code>$</code>):</li>
</ol>
<ul>
<li>
<code>r[io0-9]$</code>, one of the computer's registers <code>ri</code>, <code>ro</code>, <code>r0</code>,... <code>r9</code> or...</li>
<li>
<code>#-?[0-9]+$</code>, a literal beginning with <code>#</code> as explained above or...</li>
<li>
<code>[0-9]+$</code>, a branch destination as explained above.</li>
</ul>
<p>These are a few examples of the instructions that can be parsed:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [49]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Instruction with register operand</span>
<span class="n">match</span> <span class="o">=</span> <span class="n">RE_LINE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">'lda r0'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">'action'</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">'arg'</span><span class="p">),</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>

<span class="c1"># Instruction with literal operand</span>
<span class="n">match</span> <span class="o">=</span> <span class="n">RE_LINE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">'add      #16'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">'action'</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">'arg'</span><span class="p">),</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>

<span class="c1"># Instruction with branch destination operand</span>
<span class="n">match</span> <span class="o">=</span> <span class="n">RE_LINE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">'bgt 23'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">'action'</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">'arg'</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>lda
r0 

add
#16 

bgt
23
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If the provided string doesn't conform with the regular expression, no match object will be returned by the <code>search</code> method:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [50]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Invalid action</span>
<span class="n">match</span> <span class="o">=</span> <span class="n">RE_LINE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">'ldab r0'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>

<span class="c1"># Invalid operand</span>
<span class="n">match</span> <span class="o">=</span> <span class="n">RE_LINE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">'lda ##10'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>

<span class="c1"># No operand</span>
<span class="n">match</span> <span class="o">=</span> <span class="n">RE_LINE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">'lda'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>None 

None 

None
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For a deeper look into Python's regular expressions, here's <a href="https://realpython.com/regex-python/#">part 1</a> and <a href="https://realpython.com/regex-python-part-2/">part 2</a> of an excellent tutorial.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Using-coroutines-to-implement-programs">Using coroutines to implement programs<a class="anchor-link" href="on-being-pythonic/#Using-coroutines-to-implement-programs">¶</a>
</h3>
<p>Python lists have two characteristics that make them very suitable to represent the programs as defined in this coding challenge:</p>
<ul>
<li>They are an ordered collection of objects. A program is an ordered collection of instructions, with each instruction being a string that can be recognized using the regular expresion <code>RE_LINE</code> defined above.</li>
<li>Their individual elements can be directly accesed using and integer index. This index will serve as the program counter, i.e. the pointer to the next instruction within a program to be executed.</li>
</ul>
<p>We are going to tweak the behavior of lists a little bit, though, to control better the execution of programs. So instead of using lists directly, we are going  to use <a href="https://docs.python.org/3/library/collections.html#userlist-objects">collections.UserList</a>, a useful base class for user defined list-like classes which can inherit from them and override existing methods or add new ones. To be more precise, there will be a <code>Program</code> class that will inherit from <code>collections.UserList</code> and override the <code>__iter__()</code> method. As can be seen below, the original <code>__iter__()</code> method initializes an index <code>i</code> with <code>0</code> and proceeds to iterate sequentially over the list, returning the next element in each iteration:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [51]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">inspect</span>

<span class="nb">print</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">UserList</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>    def __iter__(self):
        i = 0
        try:
            while True:
                v = self[i]
                yield v
                i += 1
        except IndexError:
            return

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <code>__iter__()</code> method in our <code>Program</code> class will be a coroutine that will enable the implementation of branch instructions by changing the value of the index variable to any value between <code>0</code> and the <code>length - 1</code> of the program. To see how, let's take a little detour to review in more detail some Python concepts and constructs.</p>
<p>The <code>__iter__()</code> method defined by <code>collections.UserList</code> is a generator function. As explained in <a href="https://lerner.co.il/2020/05/08/making-sense-of-generators-coroutines-and-yield-from-in-python/">Making sense of generators, coroutines, and “yield from” in Python</a>:</p>
<ul>
<li>A generator function, when executed, returns a generator object.</li>
<li>A generator object implements the iterator protocol, meaning that it knows what to do in a <code>for</code> loop.</li>
<li>Each time a generator object reaches a <code>yield</code> statement, it returns the yielded value to the <code>for</code> loop that is invoking it, and goes to sleep.</li>
<li>With each successive iteration, the generator object starts running from where it paused (i.e., just after the most recent <code>yield</code> statement)</li>
<li>When the generator object reaches the end of the function, or encounters a <code>return</code> statement, it raises a <code>StopIteration</code> exception, which is how Python iterators indicate to <code>for</code> loops that they’ve reached the end of the line.</li>
</ul>
<p>Let's define a <code>collections.UserList</code> and iterate over it with a <code>for</code> loop:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [52]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">a_list</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">UserList</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">a_list</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>0
1
2
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can also interact with the generator function directly, similar to what the <code>for</code> statement does behind the scenes. An iterable object, such as a <code>collection.UserList</code>, produces a fresh new iterator or generator object each time you pass it to the iter() built-in function</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [53]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">a_list</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">UserList</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

<span class="n">g</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">a_list</span><span class="p">)</span>
<span class="n">g</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[53]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>&lt;generator object Sequence.__iter__ at 0x7f121e2693c0&gt;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Notice that when <code>iter()</code> was called, it returned a generator object. This of course happened because <code>iter()</code> in turn called the <code>__iter__()</code> in <code>collections.UserList</code>. We now execute the generator object with the <code>next()</code> built-in function:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [54]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>

<span class="k">try</span><span class="p">:</span>
    <span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'End of a_list'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>0
1
2
End of a_list
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Generator functions use the statement <code>yield</code> to produce a stream of objects so their callers can iterate over them (in a <code>for</code> loop for example). <code>yield</code>, though, can also be an expression and be placed on the right hand side of an assigment. This allows functions to consume values sent to them with their <code>send()</code> method by their callers. Such functions are called coroutines and open the possibility of concurrent programming in a single thread. Let's look at a simple example, borrowed from <a href="http://www.dabeaz.com/coroutines/">A Curious Course on Coroutines and Concurrency</a>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [55]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">grep</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">"Looking for </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">pattern</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="k">yield</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Execution of a coroutine is similar to a generator. When a coroutine is called, it returns a generator:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [56]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">grep</span><span class="p">(</span><span class="s2">"python"</span><span class="p">)</span>
<span class="n">c</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[56]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>&lt;generator object grep at 0x7f121e269580&gt;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Coroutines only run in response to the <code>next()</code> statement (like generators) and their <code>send()</code> method. All coroutines must be "primed" first by calling <code>next()</code> on them. This advances execution to the first <code>yield</code> expression. At this, point a coroutine is ready to receive a value:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [57]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Prime the coroutine so execution advances to the yield expression</span>
<span class="nb">next</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Looking for python
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [58]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Send lines to the coroutine, so it can search for the pattern "python"</span>
<span class="n">c</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">"Yeah, but no, but yeah, but no"</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">"A series of tubes"</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">"python generators and coroutines rock!"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>python generators and coroutines rock!
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As indicated above, our <code>Program</code> class inherits from <code>collections.UserList</code> and refines it as follows:</p>
<ul>
<li>It overrides the <code>__iter__()</code> method with a coroutine. This enables the <code>Computer</code> class that we will define below to iterate sequentially over the instructions in a <code>Program</code>, while making it possible to change the next instruction to be returned as a result of a branch instruction execution. An <code>int</code> value produced by the coroutine's <code>yield</code> expression is used as a pointer to the next instruction to be retrieved, thus altering the flow of execution.</li>
<li>It adds a  <code>_parse()</code> method, which parses each instruction using the regular expression presented above, performs additional checks and returns a <code>ParsedInstruction</code> named tuple with two attributes, <code>action</code> and <code>argument</code>, for ease of execution by the <code>Computer</code> class.</li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [59]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">"ParsedInstruction"</span><span class="p">,</span>
                           <span class="s2">"action, argument"</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Program</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">UserList</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">next_instruction</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">instruction</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">next_instruction</span><span class="p">]</span>
                <span class="n">next_instruction</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">branch_dest</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>
                
                <span class="c1"># Flow of execution is altered when the preceding yield</span>
                <span class="c1"># expression produces a value of type int</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">branch_dest</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">next_instruction</span> <span class="o">=</span> <span class="n">branch_dest</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">):</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">RE_LINE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'Invalid instruction "</span><span class="si">%s</span><span class="s1">"'</span> <span class="o">%</span> <span class="n">instruction</span><span class="p">)</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">'action'</span><span class="p">)</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">'arg'</span><span class="p">)</span>
        <span class="n">is_arg_literal</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'#'</span>
        <span class="n">is_branch_destination</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ACTION_SET</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'Action "</span><span class="si">%s</span><span class="s1">" not in actions set'</span> <span class="o">%</span>
                             <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">'action'</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">is_arg_literal</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">ACTIONS_NO_LITERAL</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'Action "</span><span class="si">%s</span><span class="s1">" cannot have a literal argument'</span> <span class="o">%</span>
                                 <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">'action'</span><span class="p">))</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">BRANCHES</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_branch_destination</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">'Branch "</span><span class="si">%s</span><span class="s1">" at </span><span class="si">%s</span><span class="s1"> has non branch destination "</span><span class="si">%s</span><span class="s1">"'</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">or</span> <span class="n">arg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">'Branch "</span><span class="si">%s</span><span class="s1">" to destination "</span><span class="si">%s</span><span class="s1">" jumps outside program '</span>
                    <span class="s1">'boundaries'</span> <span class="o">%</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ParsedInstruction</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's create a <code>Program</code> and its generator (coroutine) and "prime" the latter to start fetching instructions:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [60]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Define a program with 3 instructions</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">Program</span><span class="p">([</span><span class="s1">'add #10'</span><span class="p">,</span>     <span class="c1"># add 10 to the accumulator</span>
             <span class="s1">'cmp #50'</span><span class="p">,</span>     <span class="c1"># if the accumulator is greater than 50...</span>
             <span class="s1">'bgt 0'</span><span class="p">])</span>      <span class="c1"># ... loop back to the first instruction</span>

<span class="c1"># Get the Program's iterator (coroutine)</span>
<span class="n">coroutine</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="c1"># "Prime" the coroutine and fetch the first instruction</span>
<span class="n">parsed_instruction</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">coroutine</span><span class="p">)</span>
<span class="n">parsed_instruction</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[60]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>ParsedInstruction(action='add', argument=10)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We now fetch the other two instructions in the program and, for the <code>bgt</code> instruction, alter the flow of execution by sending a <code>0</code> (the first instruction's location) back to the coroutine:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [61]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Fetch the cmp instruction</span>
<span class="n">parsed_instruction</span> <span class="o">=</span> <span class="n">coroutine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">parsed_instruction</span><span class="p">)</span>

<span class="c1"># Fetch the bgt instruction</span>
<span class="n">parsed_instruction</span> <span class="o">=</span> <span class="n">coroutine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">parsed_instruction</span><span class="p">)</span>

<span class="c1"># Branch back to the add instruction at location 0</span>
<span class="n">parsed_instruction</span> <span class="o">=</span> <span class="n">coroutine</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">parsed_instruction</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>ParsedInstruction(action='cmp', argument=50)
ParsedInstruction(action='bgt', argument=0)
ParsedInstruction(action='add', argument=10)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Using-decorators-to-factor-out-logic">Using decorators to factor-out logic<a class="anchor-link" href="on-being-pythonic/#Using-decorators-to-factor-out-logic">¶</a>
</h3>
<p>By definition, a decorator is a function that takes another function as argument and extends the behavior of the latter function without explicitly modifying it. This makes decorators a great mechanism to factor-out logic that is repeated across several functions or methods. Frequently, this is "administrative" logic that is not part of the main functionality that we are implementing. In our case, we are implementing two decorators that are used by the <code>Computer</code> class defined below:</p>
<ul>
<li>As mentioned above, many <code>Computer</code> instructions can take register or literal operands. In the <code>Computer</code> class we have, for each instruction, a method that implements it. The methods for instructions that can take both types of operands are decorated with <code>get_argument</code>. This decorator retrieves the actual value to be operated on from the register specified in the instruction, when that is the case. This way, the methods can assume they only receive literal operands.</li>
<li>For debugging purposes, we may choose to log to the console the name of methods that implement instructions as they are executed, along with the arguments received. To accomplish this, we use the <code>log</code> decorator together with a <code>LOG</code> flag that is configured with <code>True</code> or <code>False</code> in the <code>Computer</code> class.</li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [62]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">functools</span>


<span class="k">def</span> <span class="nf">get_argument</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="n">functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argument</span><span class="p">):</span>
        <span class="n">to_pass</span> <span class="o">=</span> <span class="n">argument</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">argument</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">to_pass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">[</span><span class="n">argument</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_pass</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="n">functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argument</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">LOG</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">argument</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argument</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Implementing-the-computer">Implementing the computer<a class="anchor-link" href="on-being-pythonic/#Implementing-the-computer">¶</a>
</h3>
<p>We can now implement the <code>Computer</code> class. Its core is the <code>execute()</code> method, which iterates over the instructions of each program by interacting with the <code>Program</code>'s <code>__iter__()</code> coroutine in the same manner we interacted with it manually above. For each <code>parsed_instruction</code> yielded by the coroutine, <code>execute()</code> passes <code>parsed_instruction.action</code> as input to Python's <code>getattr()</code> to select and execute the specific method that implements the instruction, which receives <code>parsed_instruction.argument</code> as input. Most of the methods that implement instructions return <code>None</code> to <code>execute()</code>, which in turn sends it back to the coroutine. The exceptions are the branch instructions, of which we only have <code>bgt</code>. These branch methods return the integer representing the location of the next instruction to be executed.</p>
<p>Following the iterator protocol, <code>execute()</code> catches the <code>StopIteration</code> exception, which is the mechanism that the coroutine uses to signal the end of a program.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [63]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">LOG</span> <span class="o">=</span> <span class="kc">True</span> 


<span class="k">class</span> <span class="nc">Computer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"ri"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">"ro"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">"r0"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">"r1"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">"r2"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">"r3"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">"r4"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">"r5"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">"r6"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">"r7"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">"r8"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">"r9"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">"zero"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">"negative"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">"accumulator"</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_programs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_programs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">program</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">program</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_programs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">[</span><span class="s1">'ri'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">parsed_instruction</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">program</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">branch_dest</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parsed_instruction</span><span class="o">.</span><span class="n">action</span><span class="p">)(</span>
                    <span class="n">parsed_instruction</span><span class="o">.</span><span class="n">argument</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">parsed_instruction</span> <span class="o">=</span> <span class="n">program</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">branch_dest</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                    <span class="c1"># End of program</span>
                    <span class="k">break</span>

    <span class="nd">@get_argument</span>
    <span class="nd">@log</span>
    <span class="k">def</span> <span class="nf">lda</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argument</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">[</span><span class="s1">'accumulator'</span><span class="p">]</span> <span class="o">=</span> <span class="n">argument</span>

    <span class="nd">@log</span>
    <span class="k">def</span> <span class="nf">sto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argument</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">[</span><span class="n">argument</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">[</span><span class="s1">'accumulator'</span><span class="p">]</span>

    <span class="nd">@log</span>
    <span class="k">def</span> <span class="nf">bgt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argument</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">[</span><span class="s1">'zero'</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">[</span><span class="s1">'negative'</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">argument</span>

    <span class="nd">@get_argument</span>
    <span class="nd">@log</span>
    <span class="k">def</span> <span class="nf">cmp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argument</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">[</span><span class="s1">'accumulator'</span><span class="p">]</span> <span class="o">-</span> <span class="n">argument</span>
        <span class="c1"># Set flags in the computer state that are used by the logic</span>
        <span class="c1"># of branch methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">[</span><span class="s1">'zero'</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">v</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">[</span><span class="s1">'negative'</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span>

    <span class="nd">@get_argument</span>
    <span class="nd">@log</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argument</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">[</span><span class="s1">'accumulator'</span><span class="p">]</span> <span class="o">+=</span> <span class="n">argument</span>

    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can now define a function that creates a computer and the two programs defined by the coding challenge above:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [64]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">create_computer_and_programs</span><span class="p">():</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Computer</span><span class="p">()</span>

    <span class="c1"># p1: receive int through INPUT; add +10 to the INPUT; store result.</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">Program</span><span class="p">([</span><span class="s1">'lda ri'</span><span class="p">,</span>     <span class="c1"># load input</span>
                  <span class="s1">'add #10'</span><span class="p">,</span>    <span class="c1"># add 10 to it</span>
                  <span class="s1">'sto r0'</span><span class="p">])</span>    <span class="c1"># store result for next program</span>

    <span class="c1"># p2: load result of previous program execution; depending on if</span>
    <span class="c1">#     it's &gt; 50, set a register (r1) in machine state to 100; otherwise to 0.</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">Program</span><span class="p">([</span><span class="s1">'lda #100'</span><span class="p">,</span>   <span class="c1"># assume p1 output &gt; 50, so...</span>
                  <span class="s1">'sto r1'</span><span class="p">,</span>     <span class="c1"># ... set r1 to 100</span>
                  <span class="s1">'lda r0'</span><span class="p">,</span>     <span class="c1"># load p1 output</span>
                  <span class="s1">'cmp #50'</span><span class="p">,</span>    <span class="c1"># if p1 output...</span>
                  <span class="s1">'bgt 7'</span><span class="p">,</span>      <span class="c1"># ... is greater than 50, r1 already set up</span>
                  <span class="s1">'lda #0'</span><span class="p">,</span>     <span class="c1"># p1 output is less than 50 so ...</span>
                  <span class="s1">'sto r1'</span><span class="p">,</span>     <span class="c1"># ... set r1 to 0</span>
                  <span class="s1">'cmp #0'</span><span class="p">])</span>    <span class="c1"># noop to have destination for bgt above</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If we load <code>p1</code> with an input value of <code>40</code>, its output (stored in <code>r0</code>) will be <code>50</code>. As a consequence, <code>p2</code> will set <code>r1</code> to <code>0</code>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [65]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">c</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">create_computer_and_programs</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"p2's output = </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">c</span><span class="o">.</span><span class="n">state</span><span class="p">()[</span><span class="s1">'r1'</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>lda 40
add 10
sto r0
lda 100
sto r1
lda 50
cmp 50
bgt 7
lda 0
sto r1
cmp 0
p2's output = 0
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Whereas if <code>p1</code> is loaded with an input value of <code>41</code>, its output will be <code>51</code> and <code>p2</code> will set <code>r1</code> to <code>100</code>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [66]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">c</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">create_computer_and_programs</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="mi">41</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"p2's output = </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">c</span><span class="o">.</span><span class="n">state</span><span class="p">()[</span><span class="s1">'r1'</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>lda 41
add 10
sto r0
lda 100
sto r1
lda 51
cmp 50
bgt 7
cmp 0
p2's output = 100
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>With this we conclude the implementation of this coding challenge.</p>

</div>
</div>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="neutron-multiple-port-bindings/" class="u-url">Implementing multiple bindings for OpenStack Networking ports</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Miguel Lavalle
            </span></p>
            <p class="dateline">
            <a href="neutron-multiple-port-bindings/" rel="bookmark">
            <time class="published dt-published" datetime="2017-12-08T15:53:16-06:00" itemprop="datePublished" title="2017-12-08">2017-12-08</time></a>
            </p>
                <p class="commentline">
        
    <a href="neutron-multiple-port-bindings/#disqus_thread" data-disqus-identifier="cache/posts/neutron-multiple-port-bindings.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>One would be hard pressed to point out a more fundamental function of OpenStack
Networking (a.k.a. Neutron) than that of providing virtual ports and the
process of binding them. It is through bound ports that virtual machines
(instances) and higher level services like load balancers can access the
virtual networking provided by Neutron. In this blog post I want to provide an
overview of that process we call port binding and then explain how and why we
are implementing multiple port bindings to better support the migration of Nova
instances. This work is being done for the ML2 plug-in, which is the reference
Neutron core plug-in. The upshot is that all the ML2 based mechanism drivers
that are not part of the Neutron code repository will also be enabled with
multiple port bindings.</p>
<section id="ml2-port-binding"><h2>ML2 port binding</h2>
<p>A port is an access point to a Neutron virtual network. Virtual machines, bare
metal servers and higher level services use ports to send and receive data over
a virtual network. Binding is the process whereby the ML2 core plug-in decides
how a port is going to be connected physically to the network to which it
belongs.</p>
<p>One of the key design goals for ML2 was to support heterogeneous networking
technology across compute nodes. A simple example can be a deployment where
some of the compute nodes use OVS while others use Linux Bridge. To support
such heterogeneity, ML2 offers the concept of mechanism drivers. In our example
deployment, we would configure two mechanism drivers: the OVS driver and the
Linux Bridge driver. A mechanism driver is responsible of configuring the
physical infrastructure (OVS or Linux Bridge in our example) to bind ports to
that infrastructure so they can access their virtual network. The binding
process has a set of well defined inputs:</p>
<ul class="simple">
<li>
<p>Port attributes.</p>
<ul>
<li><p><code class="docutils literal">binding:host_id</code>. This is a string specifying the name of the host where
the port should be bound.</p></li>
<li><p><code class="docutils literal">binding:vnic_type</code>.  A Neutron port can be requested to be bound as a
virtual NIC (OVS, Linux Bridge) , direct pci-passthrough, direct macvtap
or other types. A mechanism driver only binds a port if it supports its
<code class="docutils literal">vnic_type</code>.</p></li>
<li><p><code class="docutils literal">binding:profile</code>. This is a dictionary of key / value pairs that
provides information used to influence the binding process. ML2 will
accept, store, and return arbitrary key / value pairs within the
dictionary and their semantics are mechanism driver dependent.</p></li>
</ul>
</li>
<li><p>Network infrastructure configuration. ML2 carries out the process of binding
a port outside any DB transaction. This is to allow the mechanism drivers to
configure the infrastructure by performing blocking calls.</p></li>
</ul>
<p>ML2 will attempt a binding when, during the processing of a ReST API port
create or update call, it finds that <code class="docutils literal">binding:host_id</code> is defined (not
<code class="docutils literal">None</code>) and <code class="docutils literal">binding:vif_type</code> has a value of <code class="docutils literal">VIF_TYPE_UNBOUND</code> or
<code class="docutils literal">VIF_TYPE_BINDING_FAILED</code>. Under these conditions, ML2 calls the
<code class="docutils literal">bind_port</code> method of each mechanism driver in the order in which they are
configured in the mechanism_drivers option in the <code class="docutils literal">ml2</code> section of
<code class="docutils literal">/etc/neutron/plugins/ml2/ml2_conf.ini</code>. This process continues until one of
the drivers binds the port successfully to one of the network segments or all
the drivers have been called and have failed, in which case
<code class="docutils literal">binding:vif_type</code> is set to <code class="docutils literal">VIF_TYPE_BINDING_FAILED</code>. Failure to bind
doesn't mean the ReST API call fails. A port create or update can still succeed
even though it was not possible to bind it.</p>
<p>There is much more to be said about port binding that goes beyond the scope of
this post. To learn more about the subject, you can watch the master on the
subject, Robert Kukura, giving a presentation during the 2016 OpenStack Summit
in Austin <a class="footnote-reference brackets" href="neutron-multiple-port-bindings/#id4" id="id1">1</a>.</p>
</section><section id="better-support-for-instance-live-migration-with-multiple-port-bindings"><h2>Better support for instance live migration with multiple port bindings</h2>
<p>Instance live migration consists of three stages:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal">pre_live_migration</code>. Executed before migration starts. The target host
is determined in this stage, but the instance still resides on the source.</p></li>
<li><p><code class="docutils literal">live_migration_operation</code>. This is the stage where the instance is moved
to the target host.</p></li>
<li><p><code class="docutils literal">post_live_migration</code>. The migration has concluded and the source instance
doesn't exist anymore. Up until now, this is the stage where the instance
ports were bound.</p></li>
</ol>
<p>The problem with this flow is that the port binding happens too late:</p>
<ul class="simple">
<li><p>If the binding fails, all the migration steps taken up to this point are
wasted and the instance gets stuck in an error state. If the migration is
going to fail due to port binding, we want it to happen as early as possible
in the process, preferably before the instance is migrated.</p></li>
<li><p>Network downtime is lengthened by binding the ports in the
<code class="docutils literal">post_live_migration</code> stage, since the source instance is removed before
the binding starts.</p></li>
<li><p>The destination instance definition is built using the results of the source
instance bindings (<code class="docutils literal">vif_type</code> and <code class="docutils literal">vif_details</code>). This prevents the
possibility of migrating the instance between hosts with different networking
technology, from OVS to Linux bridge for example (or to a new and promising
technology).</p></li>
</ul>
<p>To address these issues, the destination instance port binding creation needs
to be moved to the <code class="docutils literal">pre_live_migration</code> stage. But since the source instance
is still alive at this stage and using its ports bindings, we need to be able
to associate more than one binding with each port. The outline of the solution
is the following:</p>
<ul class="simple">
<li><p>A port can have more than one binding. Each binding corresponds to a specific
host.</p></li>
<li><p>Only one binding will be in <code class="docutils literal">PORT_BINDING_STATUS_ACTIVE</code>. The others will
be in <code class="docutils literal">PORT_BINDING_STATUS_INACTIVE</code>.</p></li>
<li><p>The Neutron ReST API is extended to support CRUD operations for multiple port
bindings. Also an <code class="docutils literal">activate binding</code> operation is added.</p></li>
<li>
<p>When live migrating an instance, Nova will use the new ReST API extension to:</p>
<ul>
<li><p>Create during pre_live_migration new bindings in
<code class="docutils literal">PORT_BINDING_STATUS_INACTIVE</code>.</p></li>
<li><p>Use information gathered from the inactive binding to modify the instance
definition during the <code class="docutils literal">live_migration_operation</code>.</p></li>
<li><p>Use the <code class="docutils literal">activate</code> operation to set the source instance bindings to
<code class="docutils literal">PORT_BINDING_STATUS_INACTIVE</code> and the destination instance bindings to
<code class="docutils literal">PORT_BINDING_STATUS_ACTIVE</code> once the latter instance becomes active
during the <code class="docutils literal">live_migration_operation</code>.</p></li>
<li><p>Remove the inactive bindings on the source compute host during the
<code class="docutils literal">post_live_migration</code>.</p></li>
</ul>
</li>
</ul>
<p>The specific calls in the new ReST API extension are the following (for details
on the calls requests and responses please see <a class="footnote-reference brackets" href="neutron-multiple-port-bindings/#id5" id="id2">2</a>):</p>
<ul class="simple">
<li><p><code class="docutils literal">POST <span class="pre">/v2.0/ports/{port_id}/bindings</span></code>. The request body has to specify the
<code class="docutils literal">host</code> to which the binding will be associated and can specify optionally a
<code class="docutils literal">vnic_type</code> and a <code class="docutils literal">profile</code>. The call returns <code class="docutils literal">vif_type</code> and
<code class="docutils literal">vif_details</code> and results in a 500 code if the binding fails. In the
current implementation, only instance ports (<code class="docutils literal">device_owner</code> ==
<code class="docutils literal">const.DEVICE_OWNER_COMPUTE_PREFIX</code>) can have multiple port bindings and a
maximum of 2 bindings are allowed per port.</p></li>
<li><p><code class="docutils literal">PUT <span class="pre">/v2.0/ports/{port_id}/bindings/{host_id}</span></code>. Allows the caller to update
the <code class="docutils literal">vnic_type</code> and <code class="docutils literal">profile</code>. It returns a new <code class="docutils literal">vif_type</code> and
<code class="docutils literal">vif_details</code> and results in 500 if the binding fails.</p></li>
<li><p><code class="docutils literal">PUT <span class="pre">/v2.0/ports/{port_id}/bindings/{host_id}/activate</span></code>. When applied to an
inactivate binding, it will activate it and inactivate the previously active
one. Attempting to activate an existing active binding will return a 400. It
will return a 500 if the binding fails.</p></li>
<li><p><code class="docutils literal">GET <span class="pre">/v2.0/ports/{port_id}/bindings</span></code>. Returns the bindings associated to a
port.</p></li>
<li><p><code class="docutils literal">GET <span class="pre">/v2.0/ports/{port_id}/bindings/{host_id}</span></code>. Returns the details of a
specific binding.</p></li>
</ul></section><section id="conclusion"><h2>Conclusion</h2>
<p>I have given an overview of the port binding process and how it is being
improved to better support instance live migration. This is the latest chapter
in a long history of cooperation between the Neutron and Nova teams that will
continue in the future in our joint quest to better support OpenStack users.
Please see the specification in <a class="footnote-reference brackets" href="neutron-multiple-port-bindings/#id6" id="id3">3</a> to learn how the Nova team is leveraging
multiple port bindings.</p>
<section id="references"><h3>References</h3>
<dl class="footnote brackets">
<dt class="label" id="id4"><span class="brackets"><a class="fn-backref" href="neutron-multiple-port-bindings/#id1">1</a></span></dt>
<dd>
<p>Understanding ML2 Port Binding:
<a class="reference external" href="https://www.youtube.com/watch?v=e38XM-QaA5Q&amp;t=1801s">https://www.youtube.com/watch?v=e38XM-QaA5Q&amp;t=1801s</a></p>
</dd>
<dt class="label" id="id5"><span class="brackets"><a class="fn-backref" href="neutron-multiple-port-bindings/#id2">2</a></span></dt>
<dd>
<p>Provide Port Binding Information for Nova Live Migration specification:
<a class="reference external" href="https://specs.openstack.org/openstack/neutron-specs/specs/backlog/pike/portbinding_information_for_nova.html">https://specs.openstack.org/openstack/neutron-specs/specs/backlog/pike/portbinding_information_for_nova.html</a></p>
</dd>
<dt class="label" id="id6"><span class="brackets"><a class="fn-backref" href="neutron-multiple-port-bindings/#id3">3</a></span></dt>
<dd>
<p>Use Neutron’s new port binding API specification:
<a class="reference external" href="https://specs.openstack.org/openstack/nova-specs/specs/queens/approved/neutron-new-port-binding-api.html">https://specs.openstack.org/openstack/nova-specs/specs/queens/approved/neutron-new-port-binding-api.html</a></p>
</dd>
</dl></section></section>
</div>
    </div>
    </article>
</div>



        
       <script>var disqus_shortname="miguellavalle";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha384-3lJUsx1TJHt7BA4udB5KPnDrlkO8T6J6v/op7ui0BbCjvZ9WqV4Xm6DTP6kQ/iBH" crossorigin="anonymous"></script><script type="text/x-mathjax-config">
        MathJax.Hub.Config({tex2jax: {inlineMath: [['$latex ','$'], ['\\(','\\)']]}});
        </script><!--End of body content--><footer id="footer">
            Contents © 2022         <a href="mailto:miguel@mlavalle.com">Miguel Lavalle</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
